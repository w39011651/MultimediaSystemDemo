<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>簡易聊天室（多頻道）</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 24px 32px 32px 32px;
      display: flex;
      gap: 32px;
    }
    .chat-area {
      flex: 2;
      display: flex;
      flex-direction: column;
      min-width: 350px;
    }
    #chat {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      height: 320px;
      overflow-y: auto;
      margin-bottom: 12px;
      padding: 12px;
      background: #fafbfc;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    #msg {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      background: #4f8cff;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #2563eb;
    }
    #videoInviteArea {
      margin: 12px 0;
      color: #ff9800;
      font-weight: bold;
    }
    .video-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-width: 200px;
    }
    .video-box {
      background: #222;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    video {
      border-radius: 6px;
      border: 2px solid #4f8cff;
      background: #000;
      margin-bottom: 4px;
    }
    .system-msg {
      color: #888;
      font-style: italic;
    }
    .nickname {
      color: #2563eb;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-area">
      <h2>聊天室</h2>
      <div class="input-row">
        <input id="nickname" placeholder="輸入暱稱" />
        <button onclick="connect()">連線</button>
      </div>
      <div class="input-row">
        頻道：
        <select id="channelSelect">
          <option value="general">general</option>
          <option value="music">music</option>
          <option value="game">game</option>
        </select>
      </div>
      <div id="chat"></div>
      <div class="input-row">
        <input id="msg" placeholder="輸入訊息..." />
        <button onclick="sendMsg()">送出</button>
      </div>
      <div id="videoInviteArea"></div>
      <button onclick="startVideoInvite()">開始視訊</button>
      <button id="hangupBtn" onclick="hangupCall()" style="display:none;">結束通話</button>
    </div>
    <div class="video-area">
      <div class="video-box">
        <label style="color:#fff;">本地視訊</label>
        <video id="localVideo" autoplay muted playsinline style="width:180px;height:135px;display:none;"></video>
      </div>
      <div class="video-box">
        <label style="color:#fff;">遠端視訊</label>
        <video id="remoteVideo" autoplay playsinline style="width:180px;height:135px;display:none;"></video>
      </div>
    </div>
  </div>
  <script>
    let ws, nickname, currentChannel = 'general';
    const channelHistory = {};
    let localStream, peer, isVideoStarted = false, videoInitiator = null;

    document.getElementById('channelSelect').onchange = function() {
      currentChannel = this.value;
      document.getElementById('chat').innerHTML = '';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({
          type: 'history',
          channel: currentChannel
        }));
      }
    };

    function connect() {
      nickname = document.getElementById('nickname').value || '匿名';
      ws = new WebSocket('ws://localhost:8080');
      ws.onopen = () => {
        log('<span class="system-msg">已連線到伺服器</span>');
        ws.send(JSON.stringify({ type: 'history', channel: currentChannel }));
      };
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          // 處理歷史訊息
          if (msg.type === 'history' && msg.channel === currentChannel && Array.isArray(msg.messages)) {
            channelHistory[currentChannel] = msg.messages.map(
              m => `<span class="nickname">${m.nickname}</span>：${m.text}`
            );
            document.getElementById('chat').innerHTML = '';
            channelHistory[currentChannel].forEach(m => log(m));
            return;
          }
          // 處理聊天訊息
          if (msg.type === 'chat' && msg.channel === currentChannel) {
            const line = `<span class="nickname">${msg.nickname}</span>：${msg.text}`;
            if (!channelHistory[currentChannel]) channelHistory[currentChannel] = [];
            channelHistory[currentChannel].push(line);
            log(line);
          }

          // --- WebRTC/視訊邀請相關訊息處理 ---
          if (msg.type === 'video-invite') {
            if (msg.nickname !== nickname) {
              videoInitiator = msg.nickname;
              document.getElementById('videoInviteArea').innerHTML =
                `<b>${msg.nickname} 想開啟視訊</b> <button onclick="joinVideo()">加入</button>`;
            }
          }
          if (msg.type === 'video-join' && msg.nickname !== nickname) {
            startWebRTC(true, msg.nickname);
          }
          if (msg.type === 'offer' && peer == null) {
            startWebRTC(false, msg.nickname, msg.sdp);
          }
          if (msg.type === 'answer' && peer) {
            peer.setRemoteDescription(new RTCSessionDescription(msg.sdp));
          }
          if (msg.type === 'candidate' && peer) {
            peer.addIceCandidate(new RTCIceCandidate(msg.candidate));
          }
          if (msg.type === 'hangup') {
            closeVideo();
            document.getElementById('videoInviteArea').innerHTML = '';
          }
        } catch {}
      };
      ws.onclose = () => log('<span class="system-msg">連線已關閉</span>');
    }

    function sendMsg() {
      const text = document.getElementById('msg').value;
      if (!ws || ws.readyState !== 1) return alert('請先連線');
      ws.send(JSON.stringify({
        type: 'chat',
        channel: currentChannel,
        nickname,
        text
      }));
      document.getElementById('msg').value = '';
    }

    function log(msg) {
      const chat = document.getElementById('chat');
      chat.innerHTML += msg + '<br>';
      chat.scrollTop = chat.scrollHeight;
    }

    function startVideoInvite() {
      if (!ws || ws.readyState !== 1) return alert('請先連線');
      ws.send(JSON.stringify({ type: 'video-invite', nickname }));
    }

    function joinVideo() {
      ws.send(JSON.stringify({ type: 'video-join', nickname }));
      document.getElementById('videoInviteArea').innerHTML = '';
    }

    function showHangup(show) {
      document.getElementById('hangupBtn').style.display = show ? '' : 'none';
    }

    function hangupCall() {
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'hangup', nickname }));
      }
      closeVideo();
    }

    function closeVideo() {
      if (peer) {
        peer.close();
        peer = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      document.getElementById('localVideo').srcObject = null;
      document.getElementById('localVideo').style.display = 'none';
      document.getElementById('remoteVideo').srcObject = null;
      document.getElementById('remoteVideo').style.display = 'none';
      showHangup(false);
    }

    function startWebRTC(isCaller, remoteName, remoteSdp) {
      isVideoStarted = true;
      showHangup(true);
      if (!peer) {
        peer = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });
        peer.onicecandidate = e => {
          if (e.candidate) {
            ws.send(JSON.stringify({
              type: 'candidate',
              candidate: e.candidate,
              nickname
            }));
          }
        };
        peer.ontrack = e => {
          document.getElementById('remoteVideo').srcObject = e.streams[0];
          document.getElementById('remoteVideo').style.display = '';
        };
      }
      // 取得本地串流後再進行 offer/answer
      if (!localStream) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
          localStream = stream;
          document.getElementById('localVideo').srcObject = stream;
          document.getElementById('localVideo').style.display = '';
          localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
          proceedSignaling(isCaller, remoteSdp);
        });
      } else {
        proceedSignaling(isCaller, remoteSdp);
      }
    }

    function proceedSignaling(isCaller, remoteSdp) {
      if (isCaller) {
        peer.createOffer().then(offer => {
          peer.setLocalDescription(offer);
          ws.send(JSON.stringify({
            type: 'offer',
            sdp: offer,
            nickname
          }));
        });
      } else if (remoteSdp) {
        peer.setRemoteDescription(new RTCSessionDescription(remoteSdp));
        peer.createAnswer().then(answer => {
          peer.setLocalDescription(answer);
          ws.send(JSON.stringify({
            type: 'answer',
            sdp: answer,
            nickname
          }));
        });
      }
    }
  </script>
</body>
</html>